{% extends "base.html" %}

{% block content %}
<div x-data="prescriptionData('{{ session_id }}')">
    <!-- Title -->
    <h1 class="text-3xl font-bold mb-4">Analyzed Prescription</h1>

    <!-- Tabs -->
    <div class="border-b border-gray-200 mb-8">
        <nav class="flex space-x-8" aria-label="Tabs">
            <button 
                x-on:click="activeTab = 'prescription'"
                :class="{'tab-active': activeTab === 'prescription'}"
                class="py-4 px-1 border-b-2 font-medium text-sm">
                Prescription
            </button>
            <button 
                x-on:click="activeTab = 'spellcheck'"
                :class="{'tab-active': activeTab === 'spellcheck'}"
                class="py-4 px-1 border-b-2 font-medium text-sm">
                Spell Check
            </button>
            <button 
                x-on:click="activeTab = 'order'"
                :class="{'tab-active': activeTab === 'order'}"
                class="py-4 px-1 border-b-2 font-medium text-sm">
                Order
            </button>
        </nav>
    </div>

    <!-- Prescription Tab -->
    <div x-show="activeTab === 'prescription'" x-cloak>
        <template x-if="medications.length > 0">
            <div>
                <h2 class="text-xl font-semibold mb-4">Medication Information</h2>
                <p class="text-gray-600 mb-4">Review and edit the extracted medication information below:</p>
                
                <!-- Editable Medication Table -->
                <div class="bg-white shadow-md rounded-lg overflow-hidden">
                    <div class="overflow-x-auto max-h-[600px] overflow-y-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Medication Name</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Dosage</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Quantity</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">How to Take</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">How Much</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">When to Take</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                <template x-for="(med, index) in medications" :key="index">
                                    <tr>
                                        <td class="px-6 py-4">
                                            <input type="text" x-model="med['Medication Name']" class="border-gray-300 rounded-md shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50">
                                        </td>
                                        <td class="px-6 py-4">
                                            <input type="text" x-model="med['Dosage']" class="border-gray-300 rounded-md shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50">
                                        </td>
                                        <td class="px-6 py-4">
                                            <input type="number" x-model="med['Quantity']" class="border-gray-300 rounded-md shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50">
                                        </td>
                                        <td class="px-6 py-4">
                                            <input type="text" x-model="med['How to Take']" class="border-gray-300 rounded-md shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50">
                                        </td>
                                        <td class="px-6 py-4">
                                            <input type="text" x-model="med['How Much']" class="border-gray-300 rounded-md shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50">
                                        </td>
                                        <td class="px-6 py-4">
                                            <input type="text" x-model="med['When to Take']" class="border-gray-300 rounded-md shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50">
                                        </td>
                                        <td class="px-6 py-4">
                                            <button 
                                                x-on:click="medications.splice(index, 1)"
                                                class="text-red-600 hover:text-red-900">
                                                Delete
                                            </button>
                                        </td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Add New Medication Button -->
                <button 
                    x-on:click="addNewMedication"
                    class="mt-4 bg-green-600 text-white py-2 px-4 rounded-lg hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2">
                    Add Medication
                </button>

                <!-- Save Changes Button -->
                <button 
                    x-on:click="saveMedications"
                    class="mt-4 ml-4 bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                    Save Changes
                </button>
            </div>
        </template>
        <template x-if="medications.length === 0">
            <div class="text-center py-12">
                <p class="text-gray-500">No medication data found in the processed results.</p>
            </div>
        </template>
    </div>

    <!-- Spell Check Tab -->
    <div x-show="activeTab === 'spellcheck'" x-cloak>
        <template x-if="spellCheckData.length > 0">
            <div>
                <h2 class="text-xl font-semibold mb-4">Spell Check Results</h2>
                <p class="text-gray-600 mb-4">Review the spell check results for medication names:</p>
                
                <div class="bg-white shadow-md rounded-lg overflow-hidden">
                    <div class="overflow-x-auto max-h-[600px] overflow-y-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Original Name</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Corrected Name</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Generic Names</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Brand Names</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Correctly Spelled</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Is Generic</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Notes</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                <template x-for="(drug, index) in spellCheckData" :key="index">
                                    <tr>
                                        <td class="px-6 py-4" x-text="drug['Original Name']"></td>
                                        <td class="px-6 py-4" x-text="drug['Corrected Name']"></td>
                                        <td class="px-6 py-4" x-text="drug['Generic Names']"></td>
                                        <td class="px-6 py-4" x-text="drug['Brand Names']"></td>
                                        <td class="px-6 py-4" x-text="drug['Correctly Spelled']"></td>
                                        <td class="px-6 py-4" x-text="drug['Is Generic']"></td>
                                        <td class="px-6 py-4" x-text="drug['Notes']"></td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </template>
        <template x-if="spellCheckData.length === 0">
            <div class="text-center py-12">
                <p class="text-gray-500">No spell check data found in the processed results.</p>
            </div>
        </template>
    </div>

    <!-- Order Tab -->
    <div x-show="activeTab === 'order'" x-cloak>
        <template x-if="medications.length > 0">
            <div>
                <h2 class="text-xl font-semibold mb-4">Send Order to Pharmacy</h2>

                <!-- Pharmacy Information -->
                <div class="bg-white shadow-md rounded-lg p-6 mb-6">
                    <h3 class="text-lg font-semibold mb-4">Pharmacy Information</h3>
                    <div class="max-w-md">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Pharmacy WhatsApp Number
                        </label>
                        <input 
                            type="text" 
                            x-model="pharmacyNumber"
                            placeholder="+1234567890"
                            class="w-full border-gray-300 rounded-md shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50">
                    </div>
                </div>

                <!-- Message Preview -->
                <div class="bg-white shadow-md rounded-lg p-6 mb-6">
                    <h3 class="text-lg font-semibold mb-4">Message Preview</h3>
                    <p class="text-sm text-gray-600 mb-2">Edit your message before sending:</p>
                    <textarea 
                        x-model="whatsappMessage"
                        rows="6"
                        class="w-full border-gray-300 rounded-md shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50"></textarea>
                </div>

                <!-- Send Order -->
                <div class="bg-white shadow-md rounded-lg p-6">
                    <h3 class="text-lg font-semibold mb-4">Send Order</h3>
                    <template x-if="pharmacyNumber">
                        <a 
                            :href="whatsappUrl"
                            target="_blank"
                            class="whatsapp-button inline-flex">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"/>
                            </svg>
                            <span>Send Order via WhatsApp</span>
                        </a>
                    </template>
                    <template x-if="!pharmacyNumber">
                        <div class="text-red-600">
                            Please enter a pharmacy WhatsApp number to send the order.
                        </div>
                    </template>
                </div>
            </div>
        </template>
        <template x-if="medications.length === 0">
            <div class="text-center py-12">
                <p class="text-gray-500">Please process a prescription first to generate medication data.</p>
            </div>
        </template>
    </div>

    <!-- Alpine.js Component Logic -->
    <script>
        document.addEventListener('alpine:init', () => {
            Alpine.data('prescriptionData', (sessionId) => ({
                sessionId: sessionId,
                activeTab: 'prescription',
                medications: [],
                spellCheckData: [],
                pharmacyNumber: '',
                whatsappMessage: '',
                
                init() {
                    console.log('Initializing with session ID:', this.sessionId);
                    this.loadPrescriptionData();
                    this.loadSpellCheckData();
                    
                    // Watch for changes in medications
                    this.$watch('medications', () => {
                        this.whatsappMessage = this.formatWhatsAppMessage();
                    }, { deep: true });
                },
                
                async loadPrescriptionData() {
                    try {
                        const response = await fetch(`/api/prescription/${this.sessionId}`);
                        const data = await response.json();
                        if (response.ok) {
                            this.medications = data.medications;
                            this.whatsappMessage = this.formatWhatsAppMessage();
                        }
                    } catch (err) {
                        console.error('Error loading prescription data:', err);
                    }
                },
                
                async loadSpellCheckData() {
                    try {
                        const response = await fetch(`/api/spellcheck/${this.sessionId}`);
                        const data = await response.json();
                        if (response.ok) {
                            this.spellCheckData = data.spell_check;
                        }
                    } catch (err) {
                        console.error('Error loading spell check data:', err);
                    }
                },
                
                addNewMedication() {
                    this.medications.push({
                        'Medication Name': '',
                        'Dosage': '',
                        'Quantity': '',
                        'How to Take': '',
                        'How Much': '',
                        'When to Take': ''
                    });
                },
                
                async saveMedications() {
                    try {
                        const response = await fetch(`/update-medications/${this.sessionId}`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(this.medications)
                        });
                        
                        if (response.ok) {
                            // Get the updated WhatsApp message from the response
                            const data = await response.json();
                            if (data.whatsapp_message) {
                                this.whatsappMessage = data.whatsapp_message;
                            } else {
                                // If no message in response, format it client-side
                                this.whatsappMessage = this.formatWhatsAppMessage();
                            }
                        }
                    } catch (err) {
                        console.error('Error saving medications:', err);
                    }
                },
                
                formatWhatsAppMessage() {
                    let message = "Hello, I want to order the following medicines:\n\n";
                    this.medications.forEach(med => {
                        message += `• ${med['Medication Name']} ${med['Dosage']} - Qty: ${med['Quantity']}\n`;
                    });
                    return message;
                },
                
                get whatsappUrl() {
                    if (!this.pharmacyNumber) return '#';
                    return `/send-whatsapp/${this.sessionId}?phone_number=${encodeURIComponent(this.pharmacyNumber)}&custom_message=${encodeURIComponent(this.whatsappMessage)}`;
                }
            }));
        });
    </script>
</div>
{% endblock %} 